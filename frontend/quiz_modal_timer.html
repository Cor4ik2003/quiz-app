<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quiz App</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
  <style>
   body {
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', sans-serif;
  background: #f4f6f8;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.header {
  background: #ffffff;
  color: #1a1a1a;
  padding: 15px 30px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 10;
}

.header h1 {
  margin: 0;
  font-size: 22px;
}

.container {
  display: flex;
  justify-content: flex-start; /* выравнивание влево */
  padding: 30px 60px;
  gap: 40px;
  height: calc(100vh - 50px);
  box-sizing: border-box;
}

.sidebar {
  width: 400px;
  background: #ffffff;
  border-right: 1px solid #e0e0e0;
  padding: 20px;
  overflow-y: auto;
  box-shadow: 2px 0 4px rgba(0,0,0,0.05);
}


.main {
  flex: 1;
  background: #f9fafb;
  padding: 30px;
  overflow-y: auto;
  min-width: 400px;
}

.quiz-item {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 15px 18px;
  margin-bottom: 15px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.03);
}

.quiz-item h4 {
  margin: 0 0 5px;
  font-size: 17px;
  font-weight: 600;
  color: #333;
}

.quiz-desc {
  font-size: 14px;
  color: #666;
  margin-bottom: 10px;
}

.quiz-item button {
  margin-right: 8px;
  margin-bottom: 8px;
}

button {
  background-color: #3f51b5;
  color: #fff;
  border: none;
  padding: 8px 14px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: background 0.2s;
}

button:hover {
  background-color: #303f9f;
}

.remove-btn {
  background-color: #e53935;
}

.remove-btn:hover {
  background-color: #c62828;
}

.clear-btn {
  background-color: #757575;
}

.clear-btn:hover {
  background-color: #616161;
}

input, textarea {
  width: 100%;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  margin-bottom: 15px;
  font-size: 14px;
  background: #fff;
}

.question-block, .answer-block {
  background: #f1f3f4;
  border: 1px solid #ccc;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 6px;
}

.user-info {
  font-size: 14px;
  color: #555;
  margin-right: 15px;
}


body.dark {
  background: #1a1a1a;
  color: #e0e0e0;
}

body.dark .container,
body.dark .sidebar,
body.dark .main {
  background: #222;
  color: #e0e0e0;
}

body.dark input,
body.dark textarea,
body.dark select {
  background: #333;
  color: #eee;
  border: 1px solid #555;
}

body.dark button {
  background: #555;
  color: white;
}

body.dark #theme-toggle {
  background: #f0f0f0;
  color: #222;
}
  </style>
</head>
<body>
  <div class="header">
    <h1>Quiz App</h1>
    <div>
      <span id="user-info" class="user-info"></span>
      <button id="create-btn" style="display: none;">Создать квиз</button>
      <button onclick="logout()">Выйти</button>
    </div>
  </div>

  <div class="container">
    <div class="sidebar">
      <h2>Доступные квизы</h2>
      <div id="quiz-list"></div>
    </div>

    <div class="main">
      <div id="view-panel"></div>
      <div id="create-panel" style="display: none;">
        <h2>Создание / Редактирование квиза</h2>
        <input id="quiz-title" placeholder="Название квиза" />
        <textarea id="quiz-description" placeholder="Описание квиза"></textarea>
        <div id="questions"></div>
        <button onclick="addQuestion()">+ Вопрос</button>
        <button onclick="submitQuiz()">Сохранить</button>
        <button class="clear-btn" onclick="clearForm()">Очистить форму</button>
      </div>
    </div>
  </div>

  <div id="result-modal" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.5);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(4px);
  animation: fadeIn 0.3s ease-in-out;
">
  <div style="
    background: #fefefe;
    padding: 30px;
    border-radius: 16px;
    max-width: 600px;
    width: 90%;
    text-align: center;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    font-family: 'Segoe UI', sans-serif;
    animation: slideUp 0.3s ease-in-out;
  ">
    <h2 id="modal-score" style="margin-top: 0; color: #333;"></h2>
    <div id="modal-details" style="text-align: left; margin-top: 20px; font-size: 15px; line-height: 1.5;"></div>
    <button onclick="closeResultModal()" style="
      margin-top: 20px;
      padding: 10px 20px;
      background: linear-gradient(to right, #c471f5, #fa71cd);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    ">OK</button>
  </div>
</div>

<script>
  const API = "http://localhost:8082";
  let editingQuizId = null;
  let userRole = null;

  function logout() {
    localStorage.removeItem("token");
    window.location.href = "login.html";
  }

  function showCreatePanel() {
    document.getElementById("view-panel").style.display = "none";
    document.getElementById("create-panel").style.display = "block";
    clearForm();
  }

  function clearForm() {
    document.getElementById("quiz-title").value = "";
    document.getElementById("quiz-description").value = "";
    document.getElementById("questions").innerHTML = "";
  }

  function addQuestion() {
    const container = document.getElementById("questions");
    const qBlock = document.createElement("div");
    qBlock.className = "question-block";
    const questionId = Math.random().toString(36).substring(2, 8);
    qBlock.innerHTML = `
      <input placeholder="Текст вопроса" class="question-text" />
      <div class="answers"></div>
      <button onclick="addAnswer(this, '${questionId}')">+ Ответ</button>
      <button class="remove-btn" onclick="this.parentElement.remove()">Удалить вопрос</button>
    `;
    container.appendChild(qBlock);
    for (let i = 0; i < 2; i++) {
      addAnswer(qBlock.querySelector("button"), questionId);
    }
  }

  function addAnswer(button, groupName) {
    const parent = button.closest(".question-block");
    const answersContainer = parent.querySelector(".answers");
    const aBlock = document.createElement("div");
    aBlock.className = "answer-block";
    aBlock.innerHTML = `
      <input type="radio" name="correct-${groupName}" class="is-correct" />
      <input type="text" class="answer-text" placeholder="Ответ" />
      <button class="remove-btn" onclick="this.parentElement.remove()">Удалить</button>
    `;
    answersContainer.appendChild(aBlock);
  }

  function fetchQuizzes() {
    fetch(`${API}/quizzes`)
      .then(res => res.json())
      .then(data => {
        const list = document.getElementById("quiz-list");
        list.innerHTML = "";
        data.forEach(q => {
          const div = document.createElement("div");
          div.className = "quiz-item";
          div.innerHTML = `
            <h4>${q.title}</h4>
            <p class="quiz-desc">${q.description?.substring(0, 100) || ''}</p>
            <button onclick="loadQuiz('${q.id}')">Пройти</button>
            ${userRole === 'teacher' ? `
              <button onclick="startEditQuiz('${q.id}')">Редактировать</button>
              <button class="remove-btn" onclick="deleteQuiz('${q.id}')">Удалить</button>
            ` : ''}
          `;
          list.appendChild(div);
        });
      });
  }

  
let modalTimerInterval;

function startModalTimer(duration, display) {
  let timer = duration, minutes, seconds;
  modalTimerInterval = setInterval(() => {
    minutes = parseInt(timer / 60, 10);
    seconds = parseInt(timer % 60, 10);
    minutes = minutes < 10 ? "0" + minutes : minutes;
    seconds = seconds < 10 ? "0" + seconds : seconds;
    display.textContent = minutes + ":" + seconds;
    if (--timer < 0) {
      clearInterval(modalTimerInterval);
      alert("Время вышло! Квиз будет завершён.");
      submitModalQuiz();
    }
  }, 1000);
}

function submitModalQuiz() {
  clearInterval(modalTimerInterval);
  let score = 0;
  let details = "";

  quizData.questions.forEach((q, i) => {
    const selected = document.querySelector(`#modal-quiz-questions input[name='q${i}']:checked`);
    let correctIndex = q.answers.findIndex(a => a.is_correct);

    let result = `<div style='margin-bottom: 14px;'><strong>${q.text}</strong><br/>`;

    q.answers.forEach((a, j) => {
      let cls = "";
      let mark = "";

      if (j === correctIndex) {
        cls = "correct";
        mark = "✅";
      }

      if (selected && parseInt(selected.value) === j && !a.is_correct) {
        cls = "wrong";
        mark = "❌";
      }

      result += `<span class="${cls}">${mark} ${a.text}</span><br/>`;
    });

    result += "</div>";

    if (selected && q.answers[parseInt(selected.value)].is_correct) score++;
    details += result;
  });

  document.getElementById("quiz-modal").style.display = "none";
  showResultModal(score, quizData.questions.length, details);
}

let quizData;
function loadQuiz(id) {

    fetch(`${API}/quizzes/${id}/full`)
      .then(res => res.json())
      .then(quiz => {
        const panel = document.getElementById("view-panel");
        panel.style.display = "block";
        document.getElementById("create-panel").style.display = "none";
        
quizData = quiz;
document.getElementById("modal-quiz-title").textContent = quiz.title;
document.getElementById("modal-quiz-desc").textContent = quiz.description || "";
const container = document.getElementById("modal-quiz-questions");
container.innerHTML = "";
quiz.questions.forEach((q, i) => {
  const block = document.createElement("div");
  block.className = "question-block";

  let html = `<p style="margin-bottom: 10px;"><strong>${q.text}</strong></p>`;
  q.answers.forEach((a, j) => {
    html += `
      <div style="margin-bottom: 6px;">
        <label style="display: inline-flex; align-items: center; gap: 8px;">
          <input type="radio" name="q${i}" value="${j}"> ${a.text}
        </label>
      </div>
    `;
  });

  block.innerHTML = html;
  container.appendChild(block);
});
document.getElementById("quiz-modal").style.display = "flex";
startModalTimer(600, document.getElementById("modal-timer"));
return;


        quiz.questions.forEach((q, i) => {
          const block = document.createElement("div");
          block.className = "question-block";
          block.innerHTML = `<p><strong>${q.text}</strong></p>`;
          q.answers.forEach((a, j) => {
            block.innerHTML += `
              <label><input type="radio" name="q${i}" value="${j}"> ${a.text}</label><br/>
            `;
          });
          panel.appendChild(block);
        });

        const btn = document.createElement("button");
btn.innerText = "Завершить";

btn.onclick = async () => {
  let score = 0;
  quiz.questions.forEach((q, i) => {
    const selected = document.querySelector(`input[name='q${i}']:checked`);
    if (selected) {
      const index = parseInt(selected.value);
      if (q.answers[index].is_correct) score++;
    }
  });

  const resultPayload = {
    quiz_id: quiz.id, // 👈 убедись, что quiz.id есть!
    score: score,
    total: quiz.questions.length
  };

  try {
    const res = await fetch("http://localhost:8082/results", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${localStorage.getItem("token")}`
      },
      body: JSON.stringify(resultPayload)
    });

    if (res.ok) {
      alert(`Результат отправлен: ${score}/${quiz.questions.length}`);
    } else {
      const errText = await res.text();
      alert("Ошибка отправки результата: " + errText);
    }
  } catch (err) {
    alert("Ошибка сети при отправке результата");
  }
};

panel.appendChild(btn);

      });
  }

  function submitQuiz() {
  const titleEl = document.getElementById("quiz-title");
  const descEl = document.getElementById("quiz-description");
  const questionsContainer = document.getElementById("questions");

  if (!titleEl || !descEl || !questionsContainer) {
    console.warn("Форма создания квиза недоступна на этой странице.");
    return;
  }

  const title = titleEl.value.trim();
  const description = descEl.value.trim();
  if (!title) return alert("Введите название квиза");

  const questions = [];
  let valid = true;

  questionsContainer.querySelectorAll(".question-block").forEach(q => {
    const questionText = q.querySelector(".question-text")?.value.trim();
    if (!questionText) valid = false;

    const answers = [];
    const answerBlocks = q.querySelectorAll(".answer-block");

    answerBlocks.forEach(a => {
      const answerText = a.querySelector(".answer-text")?.value.trim();
      const isCorrect = a.querySelector(".is-correct")?.checked;
      if (!answerText) valid = false;
      answers.push({ text: answerText, is_correct: isCorrect });
    });

    if (answers.length < 2 || !answers.some(a => a.is_correct)) valid = false;

    questions.push({ text: questionText, answers });
  });

  if (!valid || questions.length === 0)
    return alert("Пожалуйста, заполните все поля, добавьте хотя бы 1 вопрос и правильный ответ.");

  const payload = { title, description, questions };
  const url = editingQuizId ? `${API}/quizzes/${editingQuizId}` : `${API}/quizzes`;
  const method = editingQuizId ? "PUT" : "POST";

  fetch(url, {
    method,
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${localStorage.getItem("token")}`
    },
    body: JSON.stringify(payload)
  })
  .then(res => {
    if (!res.ok) throw new Error("Ошибка при сохранении квиза");
    alert(editingQuizId ? "Квиз обновлён" : "Квиз создан");
    clearForm();
    fetchQuizzes();
    showCreatePanel();
  })
  .catch(() => alert("Ошибка при сохранении квиза"));
}

  function startEditQuiz(id) {
    editingQuizId = id;
    fetch(`${API}/quizzes/${id}/full`)
      .then(res => res.json())
      .then(quiz => {
        showCreatePanel();
        document.getElementById("quiz-title").value = quiz.title;
        document.getElementById("quiz-description").value = quiz.description || "";
        const container = document.getElementById("questions");
        container.innerHTML = "";

        quiz.questions.forEach(q => {
          const qBlock = document.createElement("div");
          qBlock.className = "question-block";
          const questionId = Math.random().toString(36).substring(2, 8);

          const answersHtml = q.answers.map(a => `
            <div class="answer-block">
              <input type="radio" name="correct-${questionId}" class="is-correct" ${a.is_correct ? "checked" : ""} />
              <input type="text" class="answer-text" value="${a.text}" />
              <button class="remove-btn" onclick="this.parentElement.remove()">Удалить</button>
            </div>
          `).join("");

          qBlock.innerHTML = `
            <input placeholder="Текст вопроса" class="question-text" value="${q.text}" />
            <div class="answers">${answersHtml}</div>
            <button onclick="addAnswer(this, '${questionId}')">+ Ответ</button>
            <button class="remove-btn" onclick="this.parentElement.remove()">Удалить вопрос</button>
          `;

          container.appendChild(qBlock);
        });
      });
  }

  function deleteQuiz(id) {
    fetch(`${API}/quizzes/${id}`, {
      method: "DELETE",
      headers: {
        "Authorization": `Bearer ${localStorage.getItem("token")}`
      }
    })
    .then(() => {
      alert("Квиз удалён");
      fetchQuizzes();
    })
    .catch(() => alert("Ошибка при удалении квиза"));
  }

  window.onload = () => {
    const token = localStorage.getItem("token");
    if (!token) return window.location.href = "login.html";

    const decoded = jwt_decode(token);
    userRole = decoded.role;
    document.getElementById("user-info").innerText = `Вы вошли как: ${decoded.email} (${decoded.role})`;

    if (userRole === "teacher") {
      document.getElementById("create-btn").style.display = "inline-block";
      document.getElementById("create-btn").onclick = showCreatePanel;
    }

    fetchQuizzes();
  };


  function showResultModal(score, total, detailsHtml) {
  const sound = document.getElementById("result-sound");
  document.getElementById("modal-score").textContent = `Ваш результат: ${score}/${total}`;
  document.getElementById("modal-details").innerHTML = detailsHtml;
  document.getElementById("result-modal").style.display = "flex";
  sound.play();
}

function closeResultModal() {
  document.getElementById("result-modal").style.display = "none";
}

// Тема (выполняем после полной загрузки DOM)
window.addEventListener("DOMContentLoaded", () => {
  const toggleBtn = document.getElementById("theme-toggle");
  const isDark = localStorage.getItem("theme") === "dark";

  if (isDark) {
    document.body.classList.add("dark");
    toggleBtn.textContent = "☀️ Светлая тема";
  }

  toggleBtn.addEventListener("click", () => {
    document.body.classList.toggle("dark");
    const isNowDark = document.body.classList.contains("dark");
    localStorage.setItem("theme", isNowDark ? "dark" : "light");
    toggleBtn.textContent = isNowDark ? "☀️ Светлая тема" : "🌙 Тёмная тема";
  });
});

</script>

<!-- Модальное окно с таймером -->
<div id="quiz-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:30px; border-radius:10px; max-width:600px; width:90%; box-shadow:0 4px 15px rgba(0,0,0,0.3); position:relative; max-height:90vh; overflow-y:auto;">
    <h2 id="modal-quiz-title" style="margin-top:0;">Название квиза</h2>
    <p id="modal-quiz-desc" style="color:#555;"></p>
    <div id="modal-quiz-questions"></div>
    <div style="margin-top:20px; font-weight:bold;">Осталось времени: <span id="modal-timer">10:00</span></div>
    <div style="margin-top:20px;">
      <button onclick="submitModalQuiz()">Завершить</button>
    </div>
  </div>
</div>

<div id="result-modal" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.7);
  z-index: 9999;
  align-items: center;
  justify-content: center;
">
  <div style="
    background: white;
    padding: 30px;
    border-radius: 10px;
    max-width: 500px;
    width: 90%;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  ">
    <h2 id="modal-score"></h2>
    <div id="modal-details" style="text-align: left; margin-top: 20px;"></div>
    <button onclick="closeResultModal()" style="margin-top: 20px; padding: 10px 20px;">OK</button>
  </div>
</div>

<audio id="result-sound">
  <source src="https://www.soundjay.com/buttons/sounds/button-29.mp3" type="audio/mpeg">
</audio>

<button id="theme-toggle" style="
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
  padding: 8px 16px;
  border: none;
  background: #333;
  color: white;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
">🌙 Тёмная тема</button>

<button id="test-show-result" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 10000;
  padding: 8px 16px;
  border: none;
  background: #28a745;
  color: white;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
">🔍 Показать результаты</button

</body>
</html>

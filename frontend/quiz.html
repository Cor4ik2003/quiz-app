<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quiz App</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
  <style>
   body {
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', sans-serif;
  background: #f4f6f8;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.header {
  background: #ffffff;
  color: #1a1a1a;
  padding: 15px 30px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 10;
}

.header h1 {
  margin: 0;
  font-size: 22px;
}

.container {
  display: flex;
  flex: 1;
  overflow: hidden;
}

.sidebar {
  width: 320px;
  background: #ffffff;
  border-right: 1px solid #e0e0e0;
  padding: 20px;
  overflow-y: auto;
}

.main {
  flex: 1;
  background: #f9fafb;
  padding: 30px;
  overflow-y: auto;
}

.quiz-item {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 15px 18px;
  margin-bottom: 15px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.03);
}

.quiz-item h4 {
  margin: 0 0 5px;
  font-size: 17px;
  font-weight: 600;
  color: #333;
}

.quiz-desc {
  font-size: 14px;
  color: #666;
  margin-bottom: 10px;
}

.quiz-item button {
  margin-right: 8px;
  margin-bottom: 8px;
}

button {
  background-color: #3f51b5;
  color: #fff;
  border: none;
  padding: 8px 14px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: background 0.2s;
}

button:hover {
  background-color: #303f9f;
}

.remove-btn {
  background-color: #e53935;
}

.remove-btn:hover {
  background-color: #c62828;
}

.clear-btn {
  background-color: #757575;
}

.clear-btn:hover {
  background-color: #616161;
}

input, textarea {
  width: 100%;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  margin-bottom: 15px;
  font-size: 14px;
  background: #fff;
}

.question-block, .answer-block {
  background: #f1f3f4;
  border: 1px solid #ccc;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 6px;
}

.user-info {
  font-size: 14px;
  color: #555;
  margin-right: 15px;
}
  </style>
</head>
<body>
  <div class="header">
    <h1>Quiz App</h1>
    <div>
      <span id="user-info" class="user-info"></span>
      <button id="create-btn" style="display: none;">Создать квиз</button>
      <button onclick="logout()">Выйти</button>
    </div>
  </div>

  <div class="container">
    <div class="sidebar">
      <h2>Доступные квизы</h2>
      <div id="quiz-list"></div>
    </div>

    <div class="main">
      <div id="view-panel"></div>
      <div id="create-panel" style="display: none;">
        <h2>Создание / Редактирование квиза</h2>
        <input id="quiz-title" placeholder="Название квиза" />
        <textarea id="quiz-description" placeholder="Описание квиза"></textarea>
        <div id="questions"></div>
        <button onclick="addQuestion()">+ Вопрос</button>
        <button onclick="submitQuiz()">Сохранить</button>
        <button class="clear-btn" onclick="clearForm()">Очистить форму</button>
      </div>
    </div>
  </div>
<script>
  const API = "http://localhost:8082";
  let editingQuizId = null;
  let userRole = null;

  function logout() {
    localStorage.removeItem("token");
    window.location.href = "login.html";
  }

  function showCreatePanel() {
    document.getElementById("view-panel").style.display = "none";
    document.getElementById("create-panel").style.display = "block";
    clearForm();
    editingQuizId = null;
  }

  function clearForm() {
    document.getElementById("quiz-title").value = "";
    document.getElementById("quiz-description").value = "";
    document.getElementById("questions").innerHTML = "";
  }

  function addQuestion() {
    const container = document.getElementById("questions");
    const qBlock = document.createElement("div");
    qBlock.className = "question-block";
    const questionId = Math.random().toString(36).substring(2, 8);
    qBlock.innerHTML = `
      <input placeholder="Текст вопроса" class="question-text" />
      <div class="answers"></div>
      <button onclick="addAnswer(this, '${questionId}')">+ Ответ</button>
      <button class="remove-btn" onclick="this.parentElement.remove()">Удалить вопрос</button>
    `;
    container.appendChild(qBlock);
    for (let i = 0; i < 2; i++) {
      addAnswer(qBlock.querySelector("button"), questionId);
    }
  }

  function addAnswer(button, groupName) {
    const parent = button.closest(".question-block");
    const answersContainer = parent.querySelector(".answers");
    const aBlock = document.createElement("div");
    aBlock.className = "answer-block";
    aBlock.innerHTML = `
      <input type="radio" name="correct-${groupName}" class="is-correct" />
      <input type="text" class="answer-text" placeholder="Ответ" />
      <button class="remove-btn" onclick="this.parentElement.remove()">Удалить</button>
    `;
    answersContainer.appendChild(aBlock);
  }

  function fetchQuizzes() {
    fetch(`${API}/quizzes`)
      .then(res => res.json())
      .then(data => {
        const list = document.getElementById("quiz-list");
        list.innerHTML = "";
        data.forEach(q => {
          const div = document.createElement("div");
          div.className = "quiz-item";
          div.innerHTML = `
            <h4>${q.title}</h4>
            <p class="quiz-desc">${q.description?.substring(0, 100) || ''}</p>
            <button onclick="loadQuiz('${q.id}')">Пройти</button>
            ${userRole === 'teacher' ? `
              <button onclick="startEditQuiz('${q.id}')">Редактировать</button>
              <button class="remove-btn" onclick="deleteQuiz('${q.id}')">Удалить</button>
            ` : ''}
          `;
          list.appendChild(div);
        });
      });
  }

  function loadQuiz(id) {
    fetch(`${API}/quizzes/${id}/full`)
      .then(res => res.json())
      .then(quiz => {
        const panel = document.getElementById("view-panel");
        panel.style.display = "block";
        document.getElementById("create-panel").style.display = "none";
        panel.innerHTML = `<h2>${quiz.title}</h2><p>${quiz.description || ""}</p>`;

        quiz.questions.forEach((q, i) => {
          const block = document.createElement("div");
          block.className = "question-block";
          block.innerHTML = `<p><strong>${q.text}</strong></p>`;
          q.answers.forEach((a, j) => {
            block.innerHTML += `
              <label><input type="radio" name="q${i}" value="${j}"> ${a.text}</label><br/>
            `;
          });
          panel.appendChild(block);
        });

        const btn = document.createElement("button");
        btn.innerText = "Завершить";
        btn.onclick = () => {
          let score = 0;
          quiz.questions.forEach((q, i) => {
            const selected = document.querySelector(`input[name='q${i}']:checked`);
            if (selected) {
              const index = parseInt(selected.value);
              if (q.answers[index].is_correct) score++;
            }
          });
          alert(`Ваш результат: ${score}/${quiz.questions.length}`);
        };
        panel.appendChild(btn);
      });
  }

  function submitQuiz() {
    const title = document.getElementById("quiz-title").value.trim();
    const description = document.getElementById("quiz-description").value.trim();
    if (!title) return alert("Введите название квиза");

    const questions = [];
    let valid = true;

    document.querySelectorAll(".question-block").forEach(q => {
      const questionText = q.querySelector(".question-text").value.trim();
      if (!questionText) valid = false;

      const answers = [];
      const answerBlocks = q.querySelectorAll(".answer-block");

      answerBlocks.forEach(a => {
        const answerText = a.querySelector(".answer-text").value.trim();
        const isCorrect = a.querySelector(".is-correct").checked;
        if (!answerText) valid = false;
        answers.push({ text: answerText, is_correct: isCorrect });
      });

      if (answers.length < 2 || !answers.some(a => a.is_correct)) valid = false;

      questions.push({ text: questionText, answers });
    });

    if (!valid || questions.length === 0)
      return alert("Пожалуйста, заполните все поля, добавьте хотя бы 1 вопрос и правильный ответ.");

    const payload = { title, description, questions };
    const url = editingQuizId ? `${API}/quizzes/${editingQuizId}` : `${API}/quizzes`;
    const method = editingQuizId ? "PUT" : "POST";

    fetch(url, {
      method,
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${localStorage.getItem("token")}`
      },
      body: JSON.stringify(payload)
    })
    .then(res => {
      if (!res.ok) throw new Error("Ошибка при сохранении квиза");
      alert(editingQuizId ? "Квиз обновлён" : "Квиз создан");
      editingQuizId = null;
      clearForm();
      fetchQuizzes();
      showCreatePanel();
    })
    .catch(() => alert("Ошибка при сохранении квиза"));
  }

  function startEditQuiz(id) {
    editingQuizId = id;
    fetch(`${API}/quizzes/${id}/full`)
      .then(res => res.json())
      .then(quiz => {
        showCreatePanel();
        document.getElementById("quiz-title").value = quiz.title;
        document.getElementById("quiz-description").value = quiz.description || "";
        const container = document.getElementById("questions");
        container.innerHTML = "";

        quiz.questions.forEach(q => {
          const qBlock = document.createElement("div");
          qBlock.className = "question-block";
          const questionId = Math.random().toString(36).substring(2, 8);

          const answersHtml = q.answers.map(a => `
            <div class="answer-block">
              <input type="radio" name="correct-${questionId}" class="is-correct" ${a.is_correct ? "checked" : ""} />
              <input type="text" class="answer-text" value="${a.text}" />
              <button class="remove-btn" onclick="this.parentElement.remove()">Удалить</button>
            </div>
          `).join("");

          qBlock.innerHTML = `
            <input placeholder="Текст вопроса" class="question-text" value="${q.text}" />
            <div class="answers">${answersHtml}</div>
            <button onclick="addAnswer(this, '${questionId}')">+ Ответ</button>
            <button class="remove-btn" onclick="this.parentElement.remove()">Удалить вопрос</button>
          `;

          container.appendChild(qBlock);
        });
      });
  }

  function deleteQuiz(id) {
    fetch(`${API}/quizzes/${id}`, {
      method: "DELETE",
      headers: {
        "Authorization": `Bearer ${localStorage.getItem("token")}`
      }
    })
    .then(() => {
      alert("Квиз удалён");
      fetchQuizzes();
    })
    .catch(() => alert("Ошибка при удалении квиза"));
  }

  window.onload = () => {
    const token = localStorage.getItem("token");
    if (!token) return window.location.href = "login.html";

    const decoded = jwt_decode(token);
    userRole = decoded.role;
    document.getElementById("user-info").innerText = `Вы вошли как: ${decoded.email} (${decoded.role})`;

    if (userRole === "teacher") {
      document.getElementById("create-btn").style.display = "inline-block";
      document.getElementById("create-btn").onclick = showCreatePanel;
    }

    fetchQuizzes();
  };
</script>
</body>
</html>
